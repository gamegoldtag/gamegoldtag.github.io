<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Timing issues, data dependency, selector stability, network mocking, retry 전략, CI 병렬화">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://ikakao.kr/posts/post-11.html">
  <title>E2E 테스트 flaky 줄이기 — 실패 원인을 구조적으로 제거하는 방법 | Goldtag</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.min.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2446729462046987"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/gowun-batang@5.0.20/700.css">
  <link rel="stylesheet" href="/style.css">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "E2E 테스트 flaky 줄이기 — 실패 원인을 구조적으로 제거하는 방법",
    "author": { "@type": "Person", "name": "ian.lab" },
    "publisher": { "@type": "Person", "name": "ian.lab" },
    "datePublished": "2025-04-22",
    "mainEntityOfPage": { "@type": "WebPage", "@id": "https://ikakao.kr/posts/post-11.html" }
  }
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="/">Gold<span>tag</span></a>
      <nav class="nav-links" aria-label="주요 메뉴">
        <a href="/">홈</a>
        <a href="/archive.html">전체 글</a>
        <a href="/about.html">소개</a>
        <a href="/contact.html">연락처</a>
      </nav>
    </div>
  </header>

  <div class="container-narrow">
    <nav class="breadcrumb" aria-label="경로">
      <a href="/">홈</a><span class="sep">/</span>
      <a href="/archive.html">개발 기초 &amp; 팁</a><span class="sep">/</span>
      <span>현재 글</span>
    </nav>
  </div>

  <main class="post-wrap">
    <article class="post-card">
      <h1>E2E 테스트 flaky 줄이기 — 실패 원인을 구조적으로 제거하는 방법</h1>
      <p class="meta">게시일: 2025년 4월 22일 · 14분 읽기</p>

<p>CI에서 50% 확률로 실패하는 테스트가 있었다. 무시하다가 결국 폭발했다.</p>

<h3>문제: Flaky Test 란?</h3>

<p>같은 코드를 실행하는데도 때로는 통과, 때로는 실패하는 테스트.</p>

<p>우리의 경우:</p>

<pre><code>test('사용자가 음성 통화를 시작할 수 있다', async ({ page }) => {
    await page.goto('http://localhost:3000');
    await page.click('button:has-text("통화 시작")');
    await page.waitForSelector('.call-active');  // ← 이게 때때로 timeout
});
</code></pre>

<p>원인: 네트워크가 느리거나, 서버 응답이 느리면 timeout 초과</p>

<h3>Flaky의 주요 원인</h3>

<blockquote>
<p>1. Timing issues (40%)<br>
2. Data dependency (30%)<br>
3. Selector instability (15%)<br>
4. Network flakiness (10%)<br>
5. 기타 (5%)</p>
</blockquote>

<h3>해결 1: Timing Issues</h3>

<p>나쁜 방법:</p>

<pre><code>// ❌ 고정 대기
await page.waitForTimeout(1000);  // 1초 대기
</code></pre>

<p>좋은 방법:</p>

<pre><code>// ✅ 조건 기반 대기
await page.waitForSelector('.call-active', {
    timeout: 5000,  // 최대 5초
});

// 또는 더 명시적으로
await page.waitForFunction(
    () => document.querySelectorAll('.call-active').length > 0,
    { timeout: 5000 }
);
</code></pre>

<p>또 다른 패턴:</p>

<pre><code>// ✅ 네트워크 idle 대기
await page.waitForLoadState('networkidle', { timeout: 5000 });
</code></pre>

<h3>해결 2: Data Dependency</h3>

<p>문제: 테스트 데이터가 일관되지 않음</p>

<pre><code>// ❌ 나쁨: 기존 데이터 사용
test('사용자 목록을 본다', async ({ page }) => {
    await page.goto('http://localhost:3000/users');
    await page.waitForSelector('[data-testid="user-row"]');
    const count = await page.locator('[data-testid="user-row"]').count();
    expect(count).toBeGreaterThan(0);  // 때때로 실패 (데이터가 없을 수 있음)
});
</code></pre>

<p>좋은 방법:</p>

<pre><code>// ✅ 테스트마다 격리된 데이터 생성
test('사용자 목록을 본다', async ({ page }) => {
    // 1. 테스트 데이터 생성
    const testUser = await db.users.create({
        name: 'Test User ' + Date.now(),
        email: `test-${Date.now()}@example.com`,
    });

    // 2. 테스트 실행
    await page.goto('http://localhost:3000/users');
    await page.getByText(testUser.name).waitFor();

    // 3. 정리
    await db.users.delete(testUser.id);
});
</code></pre>

<h3>해결 3: Selector Instability</h3>

<p>문제: CSS selector가 변경되면 테스트 깨짐</p>

<pre><code>// ❌ 나쁨: 구현 세부사항에 의존
await page.click('.MuiButton-root:nth-child(3)');
</code></pre>

<p>좋은 방법:</p>

<pre><code>// ✅ 명확한 testid 사용
await page.click('[data-testid="start-call-button"]');

// React에서
&lt;button data-testid="start-call-button"&gt;통화 시작&lt;/button&gt;
</code></pre>

<p>또는 의미 있는 선택자:</p>

<pre><code>// ✅ 사람이 읽을 수 있는 텍스트
await page.click('button:has-text("통화 시작")');
</code></pre>

<h3>해결 4: Network Mocking</h3>

<p>문제: 실제 네트워크 의존 → 느린 서버, 끊김 등</p>

<pre><code>// ✅ API Mock
test('메시지 전송', async ({ page }) => {
    // 네트워크 응답 모킹
    await page.route('**/api/messages', route => {
        route.abort('failed');  // 네트워크 오류 시뮬레이션
    });

    await page.goto('http://localhost:3000');
    await page.fill('[data-testid="message-input"]', 'Hello');
    await page.click('[data-testid="send-button"]');

    // 에러 메시지 확인
    await page.waitForSelector('[data-testid="error-message"]');
});
</code></pre>

<p>또는 느린 네트워크:</p>

<pre><code>// ✅ 느린 네트워크 시뮬레이션
await page.route('**/api/**', async route => {
    await new Promise(resolve => setTimeout(resolve, 1000));  // 1초 지연
    await route.continue();
});
</code></pre>

<h3>해결 5: Retry 전략</h3>

<p>완벽한 테스트를 만들 수 없다면, 재시도 로직을 추가:</p>

<pre><code>// Playwright config
module.exports = {
    use: {
        // ...
    },
    webServer: {
        command: 'npm run dev',
        port: 3000,
    },
    retries: process.env.CI ? 3 : 0,  // CI에서만 3회 재시도
};
</code></pre>

<p>또는 테스트 레벨에서:</p>

<pre><code>test.describe('주요 기능', () => {
    test.describe.configure({ retries: 2 });

    test('음성 통화 시작', async ({ page }) => {
        // ...
    });
});
</code></pre>

<h3>해결 6: CI 병렬화</h3>

<p>느린 테스트를 병렬로 실행:</p>

<pre><code>// playwright.config.ts
export const config = {
    workers: process.env.CI ? 4 : 1,  // CI에서는 4개 워커
    timeout: 30 * 1000,
    expect: {
        timeout: 5000,
    },
};
</code></pre>

<h3>실전 팁</h3>

<blockquote>
<p>1. waitForSelector 대신 waitForFunction 사용<br>
2. 고정 대기(sleep)는 절대 금지<br>
3. 모든 테스트 요소에 data-testid 추가<br>
4. API는 mock, UI는 실제로 테스트<br>
5. 테스트 간 데이터 격리<br>
6. 느린 CI에서는 재시도 활성화</p>
</blockquote>

<h3>결론</h3>

<p>Flaky test는 제거할 수 없다. 하지만 원인을 구조적으로 제거하면 99% 안정화할 수 있다.</p>


      <div class="author-box">
        <div class="author-avatar">iL</div>
        <div class="author-info">
          <strong>ian.lab</strong>
          <p>28년 경력의 개발자. 실무에서 겪은 문제와 해결 과정을 기록합니다. 오류 제보는 <a href="/contact.html">연락처</a>로 보내주세요.</p>
        </div>
      </div>

      <div class="related-posts">
        <h3>관련 글 더 보기</h3>
        <div class="related-list">
        <a class="related-item" href="/posts/post-12.html">
          <span class="ri-cat">개발 기초 &amp; 팁</span>
          <span class="ri-title">로그 설계와 관측성 — 장애 대응 시간을 절반으로 줄인 운영 방식</span>
        </a>
        <a class="related-item" href="/posts/post-72.html">
          <span class="ri-cat">개발 기초 &amp; 팁</span>
          <span class="ri-title">정규표현식 실전 패턴 — 매번 검색하는 것들 총정리</span>
        </a>
        <a class="related-item" href="/posts/post-79.html">
          <span class="ri-cat">개발 기초 &amp; 팁</span>
          <span class="ri-title">개발자가 알면 좋은 네트워크 기초 — DNS부터 TCP까지</span>
        </a>
        </div>
      </div>
    </article>
</main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-links">
        <a href="/">홈</a>
        <a href="/archive.html">전체 글</a>
        <a href="/about.html">소개</a>
        <a href="/contact.html">연락처</a>
        <a href="/editorial-policy.html">운영 원칙</a>
        <a href="/privacy.html">개인정보처리방침</a>
        <a href="/terms.html">이용약관</a>
      </div>
      <div class="footer-copy">
        &copy; 2026 Goldtag. All rights reserved.<br>
        기술 정보는 실제 사용 환경에 맞게 검토 후 적용하세요.
      </div>
    </div>
  </footer>
</body>
</html>