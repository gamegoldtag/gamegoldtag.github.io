<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Structured logging, log levels, correlation IDs, alerting, Grafana/Loki, 장애 대응 프로세스">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://ikakao.kr/posts/post-12.html">
  <title>로그 설계와 관측성 — 장애 대응 시간을 절반으로 줄인 운영 방식 | Goldtag</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.min.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2446729462046987"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/gowun-batang@5.0.20/700.css">
  <link rel="stylesheet" href="/style.css">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "로그 설계와 관측성 — 장애 대응 시간을 절반으로 줄인 운영 방식",
    "author": { "@type": "Person", "name": "ian.lab" },
    "publisher": { "@type": "Person", "name": "ian.lab" },
    "datePublished": "2025-04-25",
    "mainEntityOfPage": { "@type": "WebPage", "@id": "https://ikakao.kr/posts/post-12.html" }
  }
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="/">Gold<span>tag</span></a>
      <nav class="nav-links" aria-label="주요 메뉴">
        <a href="/">홈</a>
        <a href="/archive.html">전체 글</a>
        <a href="/about.html">소개</a>
        <a href="/contact.html">연락처</a>
      </nav>
    </div>
  </header>

  <div class="container-narrow">
    <nav class="breadcrumb" aria-label="경로">
      <a href="/">홈</a><span class="sep">/</span>
      <a href="/archive.html">개발 기초 &amp; 팁</a><span class="sep">/</span>
      <span>현재 글</span>
    </nav>
  </div>

  <main class="post-wrap">
    <article class="post-card">
      <h1>로그 설계와 관측성 — 장애 대응 시간을 절반으로 줄인 운영 방식</h1>
      <p class="meta">게시일: 2025년 4월 25일 · 14분 읽기</p>

<p>새벽 3시에 장애 콜 받고 로그 뒤지는데 grep으로 30분 쓴 적 있다.</p>

<h3>문제: 로그의 무질서</h3>

<p>처음 로깅:</p>

<pre><code>console.log('User login');
console.log('DB error');
console.log('API response sent');
</code></pre>

<p>문제:</p>

<ul>
<li>어느 사용자가 로그인했나? 모름</li>
<li>어떤 DB 에러? 모름</li>
<li>시간이 안 보임</li>
<li>grep하기 어려움</li>
</ul>

<h3>Solution 1: Structured Logging</h3>

<p>JSON 형태로 로그:</p>

<pre><code>// ✅ 좋음
logger.info({
    event: 'user_login',
    userId: '12345',
    email: 'user@example.com',
    timestamp: new Date().toISOString(),
    duration: 234,  // ms
});

// 또는
logger.info('User login', {
    userId: '12345',
    email: 'user@example.com',
});
</code></pre>

<p>로그 포맷:</p>

<pre><code>{"timestamp":"2024-11-10T03:15:45Z","level":"info","event":"user_login","userId":"12345","email":"user@example.com","duration":234}
</code></pre>

<p>이제 파싱 가능하고, 검색 가능하다.</p>

<h3>로그 레벨 규칙</h3>

<pre><code>logger.debug('Entering function processAudio');  // 개발 중에만
logger.info('Call started, callId=123');         // 일반 이벤트
logger.warn('Slow query detected, 2.5s');       // 문제 신호
logger.error('Failed to save user', error);     // 에러 (복구 가능)
logger.fatal('Out of memory');                  // 중대 에러 (복구 불가)
</code></pre>

<h3>Correlation ID</h3>

<p>한 요청의 모든 로그를 추적:</p>

<pre><code>// Express middleware
app.use((req, res, next) => {
    req.correlationId = req.headers['x-correlation-id'] || crypto.randomUUID();
    res.setHeader('X-Correlation-ID', req.correlationId);
    next();
});

// 로그할 때 항상 correlationId 포함
logger.info('Processing request', {
    correlationId: req.correlationId,
    userId: req.user.id,
    path: req.path,
});
</code></pre>

<p>이제 correlationId로 한 요청의 모든 로그를 한 번에 볼 수 있다.</p>

<h3>Winston + Loki 설정</h3>

<pre><code>import winston from 'winston';
import WinstonLoki from 'winston-loki';

const logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: winston.format.json(),
    transports: [
        // Console (개발 중)
        new winston.transports.Console({
            format: winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
            ),
        }),

        // Loki (프로덕션)
        new WinstonLoki({
            host: 'http://loki:3100',
            labels: { app: 'audio-chat' },
            json: true,
        }),
    ],
});

export default logger;
</code></pre>

<h3>Loki 쿼리 예시</h3>

<p>특정 사용자의 모든 로그:</p>

<pre><code>{app="audio-chat"} | json | userId="12345"
</code></pre>

<p>에러만 보기:</p>

<pre><code>{app="audio-chat"} | json | level="error"
</code></pre>

<p>느린 요청:</p>

<pre><code>{app="audio-chat"} | json | duration > 1000
</code></pre>

<h3>Grafana Alerting</h3>

<p>조건:</p>

<blockquote>
<p>에러 로그가 1분 동안 5개 이상이면 alert</p>
</blockquote>

<pre><code>// Loki query
sum(count_over_time({app="audio-chat"} | json | level="error" [1m])) > 5
</code></pre>

<h3>장애 대응 프로세스</h3>

<p>Before (30분):</p>

<pre><code>1. SSH 접속 (2분)
2. 로그 파일 찾기 (3분)
3. grep으로 검색 (10분)
4. 원인 파악 (15분)
</code></pre>

<p>After (5분):</p>

<pre><code>1. Grafana alert 보기 (30초)
2. Loki에서 correlationId 검색 (1분)
3. 원인 명확 (3분 30초)
</code></pre>

<h3>핵심 로그 이벤트</h3>

<p>음성 채팅 앱이라면:</p>

<pre><code>logger.info('call_started', {
    callId: call.id,
    participantIds: [user1, user2],
    duration: 0,
});

logger.info('call_message_sent', {
    callId: call.id,
    userId: user.id,
    messageLength: message.length,
});

logger.error('call_connection_failed', {
    callId: call.id,
    userId: user.id,
    error: error.message,
    errorCode: error.code,
});
</code></pre>

<h3>결론</h3>

<p>로그는 애프리케이션의 눈이다. 구조화된 로그 없으면 장애 대응이 무질서하다.</p>

<p>투자:</p>

<ul>
<li>로깅 라이브러리 선택: 1시간</li>
<li>모든 로그 구조화: 1일</li>
<li>Loki/Grafana 설정: 3시간</li>
<li>총 5시간</li>
</ul>

<p>효과: 장애 대응 시간 50% 단축 (영구적)</p>

<p>가장 좋은 투자다.</p>


      <div class="author-box">
        <div class="author-avatar">iL</div>
        <div class="author-info">
          <strong>ian.lab</strong>
          <p>28년 경력의 개발자. 실무에서 겪은 문제와 해결 과정을 기록합니다. 오류 제보는 <a href="/contact.html">연락처</a>로 보내주세요.</p>
        </div>
      </div>

      <div class="related-posts">
        <h3>관련 글 더 보기</h3>
        <div class="related-list">
        <a class="related-item" href="/posts/post-11.html">
          <span class="ri-cat">개발 기초 &amp; 팁</span>
          <span class="ri-title">E2E 테스트 flaky 줄이기 — 실패 원인을 구조적으로 제거하는 방법</span>
        </a>
        <a class="related-item" href="/posts/post-72.html">
          <span class="ri-cat">개발 기초 &amp; 팁</span>
          <span class="ri-title">정규표현식 실전 패턴 — 매번 검색하는 것들 총정리</span>
        </a>
        <a class="related-item" href="/posts/post-79.html">
          <span class="ri-cat">개발 기초 &amp; 팁</span>
          <span class="ri-title">개발자가 알면 좋은 네트워크 기초 — DNS부터 TCP까지</span>
        </a>
        </div>
      </div>
    </article>
</main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-links">
        <a href="/">홈</a>
        <a href="/archive.html">전체 글</a>
        <a href="/about.html">소개</a>
        <a href="/contact.html">연락처</a>
        <a href="/editorial-policy.html">운영 원칙</a>
        <a href="/privacy.html">개인정보처리방침</a>
        <a href="/terms.html">이용약관</a>
      </div>
      <div class="footer-copy">
        &copy; 2026 Goldtag. All rights reserved.<br>
        기술 정보는 실제 사용 환경에 맞게 검토 후 적용하세요.
      </div>
    </div>
  </footer>
</body>
</html>